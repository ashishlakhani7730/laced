      if (typeof(BONZ) !== 'undefined' && BONZ.packageLoading) BONZ.packageLoading('burn_bundle');
      if("undefined"===typeof BONZ)var BONZ={};BONZ.api_domain="https://api.bonanza.com";"undefined"===typeof window.jQueryLoaded&&(window.jQueryLoaded=function(a){a()});"undefined"===typeof BONZ.packageLoaded&&(BONZ.packageLoaded=function(a){});
BONZ.loadAsset=function(a,c){var b;"js"==c?(b=document.createElement("script"),b.setAttribute("type","text/javascript"),b.setAttribute("src",a)):"css"==c&&(b=document.createElement("link"),b.setAttribute("rel","stylesheet"),b.setAttribute("type","text/css"),b.setAttribute("href",a));"undefined"!=typeof b&&document.getElementsByTagName("head")[0].appendChild(b)};BONZ.loadAsset("https://bonanzapublic.s3.amazonaws.com/assets/burn_widget_css.css?"+(new Date).getTime(),"css");
BONZ.loadAsset("https://d3dy5gmtp8yhk7.cloudfront.net/1.12/pusher.min.js","js");(function(a){for(var c=["Width","Height"],b;b=c.pop();)(function(b,c){b in new Image?a.fn[b]=function(){return this[0][b]}:a.fn[b]=function(){var a=this[0],b;"img"===a.tagName.toLowerCase()&&(b=new Image,b.src=a.src,b=b[c]);return b}})("natural"+b,b.toLowerCase())})(jQuery);
jQuery(function(){void 0==jQuery.ui&&(BONZ.loadAsset("https://ajax.googleapis.com/ajax/libs/jqueryui/"+jQuery.fn.jquery+"/jquery-ui.min.js","js"),BONZ.loadAsset("https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery.ui.slider.css","css"),BONZ.loadAsset("https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery.ui.theme.css","css"))});(function(a,c,b){a.uaMatch=function(a){a=a.toLowerCase();var b=/(opr)[\/]([\w.]+)/.exec(a)||/(chrome)[ \/]([\w.]+)/.exec(a)||/(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||0<=a.indexOf("trident")&&/(rv)(?::| )([\w.]+)/.exec(a)||0>a.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];a=/(ipad)/.exec(a)||/(iphone)/.exec(a)||/(android)/.exec(a)||/(windows phone)/.exec(a)||
/(win)/.exec(a)||/(mac)/.exec(a)||/(linux)/.exec(a)||[];return{browser:b[3]||b[1]||"",version:b[2]||"0",platform:a[0]||""}};c=a.uaMatch(c.navigator.userAgent);b={};c.browser&&(b[c.browser]=!0,b.version=c.version,b.versionNumber=parseInt(c.version));c.platform&&(b[c.platform]=!0);if(b.android||b.ipad||b.iphone||b["windows phone"])b.mobile=!0;if(b.mac||b.linux||b.win)b.desktop=!0;if(b.chrome||b.opr||b.safari)b.webkit=!0;b.rv&&(c.browser="msie",b.msie=!0);b.opr&&(c.browser="opera",b.opera=!0);b.safari&&
b.android&&(c.browser="android",b.android=!0);b.name=c.browser;b.platform=c.platform;a.browser=b})(jQuery,window);(function(a){a.fn.jqm=function(b){return this.each(function(){var c=a(this),f=c.data("jqm")||a.extend({ID:q++},a.jqm.params),f=a.extend(f,b);c.data("jqm",f).addClass("jqm-init");f.trigger&&c.jqmAddTrigger(f.trigger)})};a.fn.jqmAddTrigger=function(c){return this.each(function(){b(a(this),"jqmShow",c)||window.console&&window.console.error&&window.console.error("jqmAddTrigger must be called on initialized modals")})};a.fn.jqmAddClose=function(c){return this.each(function(){b(a(this),"jqmHide",c)||window.console&&
window.console.error&&window.console.error("jqmAddClose must be called on initialized modals")})};a.fn.jqmShow=function(b){return this.each(function(){!this._jqmShown&&c(a(this),b)})};a.fn.jqmHide=function(b){return this.each(function(){if(this._jqmShown){var c=a(this),f=b,e=c.data("jqm"),f=f||window.event,c={w:c,c:e,o:c.data("jqmv"),t:f},f=c.w,e=c.o,l=c.c;!1!==l.onHide(c)&&(f[0]._jqmShown=!1,l.modal&&(k.pop(),!k[0]&&g("unbind")),l.toTop&&e&&a("#jqmP"+l.ID).after(f).remove())}})};var c=function(b,
c){var f=b.data("jqm");c=c||window.event;var e=parseInt(b.css("z-index")),e=0<e?e:3E3,l=a("<div></div>").addClass(f.overlayClass).css({height:"100%",width:"100%",position:"fixed",left:0,top:0,"z-index":e-1,opacity:f.overlay/100}),p={w:b,c:f,o:l,t:c};b.css("z-index",e);f.ajax?(e=f.target||b,l=f.ajax,e="string"==typeof e?a(e,b):a(e),"@"==l.substr(0,1)&&(l=a(c).attr(l.substring(1))),e.html(f.ajaxText).load(l,function(){f.onLoad&&f.onLoad.call(this,p);d(p)})):d(p)},b=function(b,c,f){var e=b.data("jqm");
return!b.data("jqm")?!1:a(f).each(function(){this[c]=this[c]||[];0>a.inArray(e.ID,this[c])&&(this[c].push(e.ID),a(this).click(function(){b[c](this);return!1}))})},d=function(b){var c=b.w,f=b.o,e=b.c;!1!==e.onShow(b)&&(c[0]._jqmShown=!0,e.modal?(!k[0]&&g("bind"),k.push(c)):c.jqmAddClose(f),e.closeClass&&c.jqmAddClose(a("."+e.closeClass,c)),e.toTop&&f&&c.before('<span id="jqmP'+e.ID+'"></span>').insertAfter(f),c.data("jqmv",f),c.unbind("keydown",a.jqm.closeOnEscFunc),e.closeOnEsc&&c.attr("tabindex",
0).bind("keydown",a.jqm.closeOnEscFunc).focus())},g=function(b){a(document)[b]("keypress keydown mousedown",p)},p=function(b){b=a(b.target).data("jqm")||a(b.target).parents(".jqm-init:first").data("jqm");var c=k[k.length-1].data("jqm");return b&&b.ID==c.ID?!0:a.jqm.focusFunc(c)},q=0,k=[];a.jqm={params:{overlay:50,overlayClass:"jqm_overlay",closeClass:"jqm_close",closeOnEsc:!1,trigger:".jqModal",ajax:!1,target:!1,ajaxText:"",modal:!1,toTop:!1,onShow:function(b){0<b.c.overlay&&b.o.prependTo("body");
b.w.show();a.jqm.focusFunc(b.w);return!0},onHide:function(a){a.w.hide()&&a.o&&a.o.remove();return!0},onLoad:!1},focusFunc:function(b){a(":input:visible:first",b).focus();return!1},closeOnEscFunc:function(b){if(27==b.keyCode)return a(this).jqmHide(),!1}}})(jQuery);jQuery.timer=function(a,c){if(!c)return!1;_timer=function(a,c){this.stop=function(){clearInterval(g.id)};this.internalCallback=function(){c(g)};this.reset=function(a){g.id&&clearInterval(g.id);this.id=setInterval(this.internalCallback,a||100)};this.interval=a;this.id=setInterval(this.internalCallback,this.interval);var g=this};return new _timer(a||100,c)};jQuery.cookie=function(a,c,b){if("undefined"!=typeof c){b=b||{};null===c&&(c="",b.expires=-1);var d="";if(b.expires&&("number"==typeof b.expires||b.expires.toUTCString))"number"==typeof b.expires?(d=new Date,d.setTime(d.getTime()+864E5*b.expires)):d=b.expires,d="; expires="+d.toUTCString();var g=b.path?"; path="+b.path:"",p=b.domain?"; domain="+b.domain:"";b=b.secure?"; secure":"";document.cookie=[a,"=",encodeURIComponent(c),d,g,p,b].join("")}else{c=null;if(document.cookie&&""!=document.cookie){b=
document.cookie.split(";");for(d=0;d<b.length;d++)if(g=jQuery.trim(b[d]),g.substring(0,a.length+1)==a+"="){c=decodeURIComponent(g.substring(a.length+1));break}}return c}};BONZ.BackgroundBurner=new function(){var a=this,c=0,b=null,d=!1,g={},p=!0,q=null,k=null;a.initialize=function(){q=a.createBubbletip($("<div>For best results, try the following:<br>&bull; Choose a contrasting background<br>&bull; Take your picture such that the entire item is pictured (not cut off)</div>"),"up");$(document).on("mouseenter",".background_mask_actions .download",function(){$(".download_formats",this).show()});$(document).on("mouseleave",".background_mask_actions .download",function(){$(".download_formats",
this).hide()});r();s()};a.rotateFeaturedItems=function(){var a=$(".hand_picked_list"),b=0,c=0;a.first().show().addClass("active");$(".items_list_grid .gridblock a").attr("target","_blank");$.timer(5E3,function(){c=b+1;c>a.length-1&&(c=0);$(a[b]).hide();$(a[c]).show();b=c})};a.initializeBurnInProgress=function(){r();var a=$(".throb_container");0<a.length&&BONZ.BackgroundBurner.animateThrobber(a)};a.initializeSelectResult=function(){r();s();$("#replace_original_container").show();if(a.smallScreen())$(".select_result .burn_preview").remove();
else $(".masks .background_mask").on("mouseover",function(){$(this).hasClass("selected")||($(".masks .background_mask").removeClass("selected"),$(this).addClass("selected"),a.showMask(this))});$(document).on("keydown.select_result",function(a){86==a.which&&$(".original_burnee .background_mask:visible").fadeOut("fast")});$(document).on("keyup.select_result",function(a){86==a.which&&(a=$(".background_mask.selected").data("mask-id"),$(".original_burnee .background_mask[data-mask-id="+a+"]").fadeIn("fast"))});
a.showMask($(".masks .background_mask").first().addClass("selected"))};a.showMask=function(a){a=$(".mask",$(a)).attr("data-mask-id");var b=$(".original_burnee .background_mask[data-mask-id="+a+"]");a=$(".original_burnee .background_mask:visible");0<a.length?a.stop().fadeOut("fast",function(){b.fadeIn("fast")}):b.fadeIn("fast")};a.initializeFinalMask=function(){r();var a=$(".background_mask"),b=$("img.final_result_mask",a);if(0<b.length)BONZ.MaskEditor.onImageLoad(b,function(){$(".loading",a).remove()});
else $(".loading",a).remove()};a.getDomain=function(){return BONZ.api_domain||$("#show_burn_main_container").data("domain")||""};a.listenForBurns=function(a,c){if(!b){var v=null;void 0===c&&(v=c=h);b=new Pusher("b52edcd4361775ece96a");b.subscribe("background-burner").bind("burn-countdown",function(a){k.reset(1E4);parseInt($("#burn_pop_container").data("burn-id"))==a.burn_id?f(a.burn_id):l(e()-1)});var d=1E4;a?b.subscribe("burn-"+a).bind("burn-some-masks-complete",function(a){null!=v&&v(a.burn_id)}).bind("burn-complete",
function(a){k.stop();c(a.burn_id)}):d=1E3;k=$.timer(d,function(){m(c)})}};a.completeSubmitInput=function(){$("#add_images_container").removeClass("loading")};a.showLoadingSpinner=function(a){a=$("#background_burn-"+a);a.addClass("loading");a.find(".burn_loader").height(a.outerHeight())};a.hideLoadingSpinner=function(a){$("#background_burn-"+a).removeClass("loading")};a.setCredentials=function(a){g=a};a.getCredentials=function(){return g};a.copyCredentialsToForm=function(a){g&&g!={}&&($(a).find("#submit_burn_user_id").val(g.burn_user_id),
$(a).find("#submit_access_token").val(g.access_token))};a.setBurnIsVisible=function(){d=!0};a.shouldSolicitBurnFeedback=function(){return p};a.setSolicitBurnFeedback=function(a){p=a};a.animateThrobber=function(b){var c=$(".mask_throbber",b),e=$("#starting_pic",b),f=$("#saturation_pic",b),l=$("#canny_pic",b),d=function(){e.animate({opacity:1},1E3).animate({opacity:0},5E3);f.animate({opacity:1},7E3,function(){f.animate({opacity:0},5E3);l.animate({opacity:1},5E3)})},p=function(){var a=$(".background_masks").width()-
$(".throb_container").width()-10,f=$("#flames_pic",b).css("width",e.width()).css("height",e.height()).show(),l=$("#dragon_container"),p=$("#fire_breath",l);b.animate({left:0},1E3,function(){l.fadeIn(1E3);b.animate({left:"+="+a},19E3,"linear",function(){c.css("width",e.width()).css("height",e.height());c.delay(1E3).fadeIn(1E4)});n()||(0<l.length&&(p.fadeIn(3E3,function(){$({top:6}).animate({top:0},{duration:500,easing:"linear",step:function(a){0==Math.floor(a)%3&&p.css({top:54+Math.floor(a)})}}).animate({top:6},
{duration:500,easing:"linear",step:function(a){0==Math.floor(a)%3&&p.css({top:54+Math.floor(a)})},complete:arguments.callee})}),f.animate({opacity:0.7},3E3).animate({opacity:0.3},1E3).animate({opacity:0.6},4E3).animate({opacity:0.2},3E3).animate({opacity:0.7},6E3,function(){p.fadeOut(2E3)}).animate({opacity:0},2E3,function(){l.css({transform:"scaleX(-1)","-webkit-transform":"scaleX(-1)","-moz-transform":"scaleX(-1)","-o-transform":"scaleX(-1)","-ms-transform":"scaleX(-1)"}).animate({left:"-=350"},
1E4,"linear").fadeOut(500)})),d())})};b.show();if(a.smallScreen())d(),setInterval(d,12E3);else BONZ.MaskEditor.onImageLoad(e,p)};a.approveBurn=function(a){a=$(a).parents(".burn_work_window");var b=a.attr("id").split("-")[1];t(a,b,{background_burn_suggestion:{approved:1}})};a.archiveBurn=function(a){a=$(a).parents(".burn_work_window");var b=a.attr("id").split("-")[1],e=!1;switch(c){case 0:e=confirm("Are you sure you want to remove this image from your list?\n\nIf you want it back, you'll have to add it again.");
break;case 1:e=confirm("Are you sure you want to remove this image from your list?\n\nWe're not going to ask you anymore after this until you reload the page...");break;default:e=!0}c++;e&&t(a,b,{background_burn:{archived:1}})};a.afterLoadBurn=function(){$(document).on("mouseenter","#show_burn_main_container .best_result_trigger",function(){0==$(this).siblings(".bubbletip").length&&$(this).parent(".best_results").append(q);q.show()});$(document).on("mouseleave","#show_burn_main_container .best_result_trigger",
function(){q.hide()})};a.extractDigitFromString=function(a){return res=(match=/\d+/.exec(a))?match[0]:null};a.browserCanBurn=function(){return window.CanvasRenderingContext2D&&window.FormData};a.createBubbletip=function(a,b){"string"!=typeof b&&(b="down");var c=$('<div class="bubbletip"></div>'),e=$('<div class="bubbletip_arrow bubbletip_arrow_'+b+'"></div>'),f=$('<div class="bubbletip_inner"></div>');f.append(a);c.append(e);c.append(f);return c};a.createFakeTitleTip=function(a){a=$(a);if(!(void 0===
a.data("title")||""==a.data("title"))){var b=$(window).width(),c=a.offset(),e=a.outerWidth();a=$("<div />").addClass("fake_title").text(a.data("title"));$("body").append(a);var f=a.outerWidth(),l=c.top-27,c=c.left-(f-e)/2;0>c?c=1:c+f>b&&(c=b-f-1);a.css({top:l,left:c})}};a.smallScreen=function(){return 800>$(window).width()};var h=function(a){var b=$("#background_burn-"+a),c=$("#show_burn_main_container").data("source");$.ajax({type:"GET",url:BONZ.BackgroundBurner.getDomain()+"/background_burns/"+
a,dataType:"HTML",xhrFields:{withCredentials:!0},data:$.extend(g,{partial:!0,source:c}),success:function(c){b.length&&b.hasClass("some_masks_complete")?(c=$(c),$(".masks .background_mask",c).each(function(a,b){var c=$(b).data("mask-id");0==$('.masks .background_mask[data-mask-id="'+c+'"]').length&&($(".masks .additional_masks_loading").before(b),$(b).hide().delay(250*a).fadeIn("slow"))}),$(".original_burnee .background_mask",c).each(function(a,c){var e=$(c).data("mask-id");0==$('.original_burnee[data-mask-id="'+
e+'"]',b).length&&$(".original_burnee",b).append(c)}),$(".burn_work_window",c).andSelf().filter(".burn_work_window").first().hasClass("complete")&&(b.removeClass("incomplete some_masks_complete").addClass("complete"),$(".masks .additional_masks_loading").remove()),c.filter("script").appendTo(b)):b.replaceWith(c);$("#background_burn-"+a).hasClass("complete")&&$(".poll_box").hide()}})},m=function(a){if(!d)return!1;var b=$("#background_burns .burn_work_window.incomplete"),b=$.map(b,function(a){return $(a).attr("id").split("-")[1]});
0!=b.length&&(b=$.extend(g,{burn_ids:b}),$.ajax({type:"GET",data:b,dataType:"JSON",url:BONZ.BackgroundBurner.getDomain()+"/background_burns/poll_burn_status",xhrFields:{withCredentials:!0},success:function(b){if("undefined"==typeof b)return!1;$(b).each(function(b,c){c.done?(k.stop(),$("#burn_throbber_"+c.id).hide(),a(c.id)):0==c.queue_position&&0!=$("#background_burn-"+c.id).data("queue-spot")?f(c.id):0<c.queue_position&&l(c.queue_position)})}}))},f=function(a){$("#waiting").remove();$("#processing").show();
r();BONZ.BackgroundBurner.animateThrobber($("#burn_throbber_"+a));$("#background_burn-"+a).data("queue-spot",0)},e=function(){return parseInt($("#burn_queue_position").text())},l=function(a){a=Math.max(1,Math.min(e(),a));$("#burn_queue_position").html(a)},r=function(){$(".images_container img").each(function(){var a=$(this);BONZ.MaskEditor.onImageLoad(a,function(){a.naturalWidth()>=a.naturalHeight()?a.addClass("landscape"):a.addClass("portrait")})})},n=function(){if("Microsoft Internet Explorer"==
navigator.appName){var a=navigator.userAgent.indexOf("MSIE");return-1==a?!1:9>parseInt(navigator.userAgent.substring(a+4+1))}return!1},t=function(b,c,e){a.showLoadingSpinner(c);$.ajax({type:"PUT",data:$.extend(g,e),url:BONZ.BackgroundBurner.getDomain()+"/background_burns/"+c,xhrFields:{withCredentials:!0},success:function(a){0==b.parents("#background_burns.gallery").length?b.fadeOut("fast",function(){$(this).remove()}):document.location.href=document.location.href.split("#")[0]}})},s=function(){$(".background_mask").each(function(){var a=
$(this),b=$("img.mask",a);BONZ.MaskEditor.onImageLoad(b,function(){$(".loading",a).remove()})})}};jQuery(BONZ.BackgroundBurner.initialize);BONZ.BurnPop=new function(){var a=this,c=null,b=0,d=0;this.initialize=function(){c=BONZ.BackgroundBurner.getDomain();b=$(window).scrollLeft();d=$(window).scrollTop();$(window).on("scroll.burn_pop",function(){$("#burn_pop_container").is(":visible")?window.scrollTo(b,d):(b=$(window).scrollLeft(),d=$(window).scrollTop())})};this.createFrom=function(a){a.empty();a.jqm().jqmShow();BONZ.BackgroundBurner.setBurnIsVisible();a.html("Receiving upload and initializing Background Burner...")};this.showSpinner=
function(){var a=$("#burn_pop_container"),b=a.find("#main_spin_container");b.get(0)||(b=$('<div id="main_spin_container">'),a.prepend(b));b.height(a.outerHeight());b.width(a.outerWidth());b.show()};this.hideSpinner=function(){$("#burn_pop_container #main_spin_container").hide()};this.selectMask=function(b,c){c(parseInt(a.getCurrentBurnId()),b,parseInt(a.getCurrentItemId()))};this.replaceBackgroundOpenPanel=function(a){$(".final_mask").hide();$.ajax({url:c+"/background_replacements/public",data:{burn_id:g($(".burn_work_window").attr("id"))},
success:function(b){$("#replacement_gallery").html(b).show();a&&a()}})};this.replaceBackgroundClosePanel=function(){$("#replacement_gallery").hide();$(".final_mask").show()};this.getCurrentBurnId=function(){return $("#burn_pop_container").attr("data-burn-id")};this.getCurrentItemId=function(){return $("#burn_pop_container").data("item-id")};this.closeWindow=function(){$(".imageOverlay").remove();$("#burn_pop_container").jqmHide()};this.launchBBDialog=function(b,d){var g=$("#"+d.dialog_id).removeClass("editing"),
h=d.html_target_id&&$("#"+d.html_target_id)||g;g.get(0)||(g=$('<div id="'+d.dialog_id+'" class="popup_container">'),$(d.append_to||"body").append(g));a.createFrom(g);g.attr("data-burn-id",b);d.load_message&&g.html(d.load_message);d.item_id&&g.attr("data-item-id",d.item_id);d.route&&(g={background_burn:b},d.passthroughParams&&$.extend(g,d.passthroughParams),a.showSpinner(),$.ajax({type:"GET",data:g,dataType:"HTML",url:c+d.route+b,success:function(b){a.hideSpinner();h.html(b);d.successCallback&&d.successCallback(b)}}))};
this.useMask=function(b,d,g,h){BONZ.BackgroundBurner.showLoadingSpinner(b);$.ajax({type:"PUT",url:c+"/background_burns/"+b,data:{background_burn:{selected_mask_id:d}},dataType:"html",success:function(c){BONZ.BackgroundBurner.hideLoadingSpinner(b);$("#background_burn-"+b).replaceWith(c);a.close()}})};this.close=function(){BONZ.MaskEditor.close();$("#burn_pop_container").jqmHide()};this.clickTouchUp=function(b,c,d){var h=$(b).parents(".background_mask");b=g(h.attr("id"));h=h.data("burn-id");a.editMask(b,
h,c,d)};this.editMask=function(a,b,c,d){$("#show_burn_main_container").hide();$("#burn_pop_container").attr("data-burn-id",b);BONZ.MaskEditor.initialize(a,c,d)};this.fullScreenFailFeedback=function(){a.closeWindow()};this.feedbackResponse=function(a,b){$(a).delay(3E3).hide("fast");$(a).find("form").hide();$(a).find(".feedback_response").show();$(a).find(".hidden_spinner").hide();$("#burn_pop_container").jqmHide();$(".imageOverlay").remove()};this.launchLogin=function(a){"undefined"!=typeof a&&(BONZ.User.postLoginCallback=
a,BONZ.User.postCreateCallback=a);$(document).on("submit","#user_login_popup .sessions_new_form form",function(a){a.preventDefault();var b=$(a.target);a=b.attr("action");$("input[type=submit]",b).after($('<div class="popup_spinner"></div>'));$.ajax({type:"POST",url:a,data:b.serialize(),dataType:"json",success:function(a){$(".popup_spinner").remove();a.success?BONZ.User.postLoginCallback(a):b.parents("table").before($('<div class="explanation_message error_explanation">'+a.error+"</div>"))}})});BONZ.Application.launchPopup("#user_registration_popup")};
var g=function(a){return(a=/\d+/.exec(a))?a[0]:null}};jQuery(BONZ.BurnPop.initialize);"undefined"===typeof BONZ&&(BONZ={});
BONZ.BurnWidget=function(a){var c,b={},d={onIndex:null,onShow:null,onCreate:null,onSave:null,onError:null,apiKey:null,userId:null,callback:null,appendTo:"body",isDemo:!1,suggestedItemId:null},g=null;this.launch=function(a){a=a||{};c=this;var b=$(a.image).attr("src")||a.url||null,f=$(a.image).data("userId")||d.userId||null,p=$(a.image).data("id")||a.id||null,f={success:h,error:m,data:{key:d.apiKey,user_id:f,callback:a.callback||d.callback||null,launch:!0,url:b},dataType:"json"};g=a.image?$(a.image).selector:
null;$("#background_burns").get(0)||$(d.appendTo).append('<div id="background_burns">');BONZ.BurnPop.launchBBDialog(null,{dialog_id:"burn_pop_container",load_message:"Loading Background Burner...",burnId:p,append_to:"#background_burns"});BONZ.BurnPop.createFrom($("#burn_pop_container"));null!=p?$.extend(f,{type:"GET",url:BONZ.BackgroundBurner.getDomain()+"/api/background_burns/"+p}):null!=b?$.extend(f,{type:"POST",url:BONZ.BackgroundBurner.getDomain()+"/api/background_burns"}):$.extend(f,{type:"GET",
url:BONZ.BackgroundBurner.getDomain()+"/api/background_burns"});$.ajax(f)};var p=function(a){a=BONZ.BackgroundBurner.extractDigitFromString($(a).parents(".background_mask").attr("id"));BONZ.BurnPop.selectMask(a,q)},q=function(a,b,f){BONZ.BurnPop.showSpinner();b={key:d.apiKey,user_id:d.userId,_method:"PUT",selected_mask_id:b};$.ajax({type:"POST",url:BONZ.BackgroundBurner.getDomain()+"/api/background_burns/"+a,dataType:"json",data:b,success:function(b){c.launch({id:a});if(d.onSave)d.onSave($(g),b)}})},
k=function(){$("#show_burn_main_container").hide();$("#replacement_gallery").hide();BONZ.MaskEditor.close();$("#show_burn_main_container").show()},h=function(a){if(a)if(b={burn_user_id:a.burn_user_id,access_token:a.access_token},BONZ.BackgroundBurner.setCredentials(b),$("#burn_pop_container").html(a.html),"index"==a.action){if(BONZ.BackgroundBurner.initializeSelectResult(),d.onIndex)d.onIndex(a)}else if(0<$(g).length&&$(g).attr("data-user-id",a.user_id).attr("data-id",a.id),a.complete||BONZ.BackgroundBurner.listenForBurns(a.burn_user_id,
f),"create"==a.action&&d.onCreate)d.onCreate($(g),a);else if("show"==a.action&&d.onShow)d.onShow($(g),a)},m=function(a){a=$.parseJSON(a.responseText);$("#burn_pop_container").html(a.html);if(d.onError)d.onError(a.type,a.message)},f=function(a){$.ajax({type:"GET",url:BONZ.BackgroundBurner.getDomain()+"/api/background_burns/"+a,success:h,error:m,data:$.extend({key:d.apiKey,user_id:d.userId,launch:!0},b),dataType:"json"})};(function(a){$.extend(d,a);$(document).on("click",".use_it_button",function(a){a.preventDefault();
p(this)});$(document).on("click",".select_result .background_mask .original_and_mask_container",function(a){a.preventDefault();p(this)});$(document).on("click",".closer_x",function(){$("#burn_pop_container").jqmHide()});$(document).on("click",".burn_index .burnee .incomplete",function(a){a.preventDefault();c.launch({id:$(this).data("id")})});if(BONZ.BackgroundBurner.browserCanBurn())$(document).on("click",".touch_up_button",function(a){BONZ.BurnPop.clickTouchUp(this,q,k)});else $("#burn_pop_container").addClass("no-canvas")})(a)};BONZ.BackgroundReplacement=new function(){var a=this,c=null,b=null,d=null,g=null,p=null,q=null,k="popup",h=null;this.initialize=function(){d=$("#replacement_gallery");g=d.find("#result_side_container");c=extractDigitFromString($(".burn_work_window").attr("id"))||extractDigitFromString($(".burn_id_container").attr("id"));$(".save_back_buttons .login_button",d).on("click",function(b){b.preventDefault();BONZ.BurnPop.launchLogin(a.insertDownloadButton)});$(".save_back_buttons .save_and_download",d).on("click",
BONZ.BackgroundReplacement.complete);$(".replacement_category",d).on("click",function(){var a=$(this);$("#manipulation_container").show();$("#category_choose_container").hide();var b=$("#replacement_choose_container");b.show();b.find(".category_blob").hide();b.find("#category_"+extractDigitFromString(a.attr("id"))+"_container").show()});BONZ.Application.lazy(function(){g.show();b=g.find("#burned_image");BONZ.MaskEditor.onImageLoad(b,m)});var e=$(".all_options_container .bg_candidate",d);e.on("mouseenter",
function(){var a=f(this);a.attr("id","hovered_background");g.find("#background_holder").append(a)});e.on("mouseleave",function(){g.find("#hovered_background").remove()});$(".all_options_container .bg_candidate",d).on("click",function(){d.find(".chosen_one").removeClass("chosen_one");$(this).addClass("chosen_one");var a=f(this);g.find("#selected_background").remove();a.attr("id","selected_background");g.find("#background_holder").append(a)});$("#bg_upload_form input").on("change",function(){BONZ.BurnSizzle&&
BONZ.BurnSizzle.enableNavigationConfirmation("You have unsaved changed, are you sure you want to leave this page?");$(this).closest("form").ajaxSubmit({beforeSubmit:function(a,b,c){$("#custom_bg_spinner").show();c.dataType="json"},complete:function(a){a=$.evalJSON(a.responseText);$("#custom_bg_spinner").hide();d.find(".chosen_one").removeClass("chosen_one");var b=g.find("#images_holder"),c=$("<img class='background_replacement' src='"+a.image_url+"'>");c.width(b.width());b=d.find(".your_background_target");
b.html($("<img class='user_bg' src='"+a.image_url+"'>"));b.addClass("chosen_one").attr("id","bg_replacement_"+a.replacement_id);g.find("#selected_background").remove();c.attr("id","selected_background");g.find("#background_holder").append(c);$("#category_choose_container").hide();$("#your_background_container").show()}})})};this.setResultDestination=function(a){k=a};this.setCompleteCallback=function(a){h=a};this.complete=function(a){a.preventDefault();a=$(a.target).siblings("label").find("input[name=include_in_hof]").prop("checked")?
1:0;BONZ.BackgroundBurner.showLoadingSpinner(c);$("#bg_swap_spinner, #your_bg_spinner").show();$.ajax({type:"POST",url:"/background_replacements/choose",data:{burn_id:c,duplicate:"share"==k,id:extractDigitFromString(d.find(".chosen_one").attr("id")),include_in_hof:a,burn_x_pos:$("#burn_x_pos").val(),burn_y_pos:$("#burn_y_pos").val(),burn_width:$("#burn_width").val(),burn_viewport_size:$("#burn_viewport_size").val()},dataType:"JSON",success:function(a){BONZ.BurnSizzle&&BONZ.BurnSizzle.disableNavigationConfirmation();
d.hide();BONZ.BackgroundBurner.hideLoadingSpinner(c);var b=null;if("popup"==k){b=a.image_url;a=$(".final_mask");var e=$("#background_replace_image");0==e.length&&(e=$("<img id='background_replace_image' />"),$(".original_and_mask_container .inner_container",a).prepend(e));e.attr("src",b);b=a;a="http://www.bonanza.com/pic/"+c;b.find("a.facebook").attr("href","http://www.facebook.com/sharer/sharer.php?u="+a);b.find("a.twitter").attr("href","http://www.twitter.com/share?url="+a);b.find("a.direct").attr("href",
a);b.find("img.original, img.final_result_mask").hide();b.find(".download_formats").remove();b.show();h()}else window.location=a.reshare_result_url;return!0}})};this.insertDownloadButton=function(){var a=$(".save_back_buttons .login_button"),b=$('<label><input checked="checked" name="include_in_hof" type="checkbox" value="1"> Add this pic to the <a href="/hall_of_fame" target="_blank">Bonanza Hall of Fame</a></label><br />'),c=$('<a href="#" class="save_and_download button51">Save &amp; Download</a>');
0<a.length&&(c.insertAfter(a),b.insertAfter(a),a.remove(),BONZ.BurnSizzle.insertDownloadButton(),BONZ.Application.launchPopup("#burn_pop_container"))};this.hideUploadedImage=function(){$("#your_background_container").hide();$("#category_choose_container").show();BONZ.BurnSizzle&&BONZ.BurnSizzle.disableNavigationConfirmation()};var m=function(){var a=g.find("#images_holder");0==b.width()&&b.width(b.naturalWidth());0==b.height()&&b.height(b.naturalHeight());if(b.width()>a.width()||b.height()>a.height())b.width()>
b.height()?b.css("width",a.width()):b.css("height",a.height());var c=a.width()-b.width(),f=a.height()-b.height();b.css("top",f/2);$("#burn_y_pos").val(b.css("top"));b.css("left",c/2);$("#burn_x_pos").val(b.css("left"));b.draggable({drag:function(){a.find("#burn_x_pos").val($(this).css("left"));a.find("#burn_y_pos").val($(this).css("top"))},start:function(){$(this).addClass("grabbed")},stop:function(){$(this).removeClass("grabbed")}});p=b.width();q=b.height();$("#burn_width").val(p);g.find("#scale_slider").slider({animate:"fast",
min:10,max:300,value:100,slide:function(a,c){var e=c.value;b.width(p*(e/100));b.height(q*(e/100));$("#burn_width").val(b.width())}});b.closest("#images_holder").removeClass("loading")},f=function(a){a=$(a).find(".background");var b=$("<img class='background_replacement' src='"+a.attr("src").replace("_thumb200","")+"'>"),c=g.find("#background_holder"),f=d.find("#images_holder");c.height(f.height()).width(f.width());var c=f.height()/a.height(),p=f.width()/a.width(),c=c<p?p:c;b.height(a.height()*c);
b.width(a.width()*c);0<(heightOverflow=b.height()-f.height())&&b.css("top",-(heightOverflow/2));0<(widthOverflow=b.width()-f.width())&&b.css("left",-(widthOverflow/2));$("#burn_viewport_size").val(a.width()*c);return b}};var ImageTools=function(){var a={},c;c="Uint8ClampedArray"in window?function(a){return new Uint8ClampedArray(new ArrayBuffer(a))}:function(a){return Array(a)};var b=function(){try{return new ImageData(1,1),function(a,b){return new ImageData(a,b)}}catch(a){var b=document.createElement("canvas");return function(a,c){b.width=a;b.height=c;return b.getContext("2d").createImageData(a,c)}}}();a.Context={};a.Context.fillCheck=function(a,b,c,d,h){var m=a.lineWidth,f=2*m,e=a.fillStyle,l=0;a.fillStyle=a.strokeStyle;
a.fillRect(b,c,d,h);for(a.fillStyle=e;c<h;c+=m){for(e=b+m*(l%2);e<d;e+=f)a.fillRect(e,c,m,m);l+=1}};a.Image={};a.Image.convolve=function(a,c,d){var k=d.width,h=d.data;d=b(k,d.height);for(var m=d.data,f=Math.sqrt(a.length),e=Math.floor(f/2),l=[],r=0;r<f;r+=1)for(var n=0;n<f;n+=1)l.push(4*((r-e)*k+(n-e)));for(k=0;k<h.length;k+=4){for(var t=n=r=e=f=0;t<a.length;t+=1){var s=k+l[t];if(0>s||s>=h.length)s=k;var u=a[t],f=f+h[s]*u,r=r+h[s+1]*u,e=e+h[s+2]*u;c||(n+=h[s+3]*u)}m[k]=f;m[k+1]=r;m[k+2]=e;m[k+3]=
c?h[k+3]:n}return d};var d=a.ChannelData=function(a,b,d){3>arguments.length&&(d=b,b=a,a=c(b*d));this.data=a;this.width=b;this.height=d};a.Channel={};a.Channel.extract=function(a,b){for(var c=b.data,k=new d(b.width,b.height),h=k.data,m=0;m<h.length;m+=1)h[m]=c[4*m+a];return k};a.Channel.threshold=function(a,b){for(var c=b.data,k=new d(b.width,b.height),h=k.data,m=0;m<c.length;m+=1)h[m]=c[m]>=a?255:0;return k};a.Channel.invert=function(a){var b=a.data;a=new d(a.width,a.height);for(var c=a.data,k=0;k<
b.length;k+=1)c[k]=255-b[k];return a};a.Channel.erode=function(a,b){for(var q=b.data,k=b.width,h=b.height,m=k-1,f=h-1,e,l=0;l<a;l+=1){var r=c(q.length);for(e=0;e<q.length;e+=1)r[e]=255;for(var n=0;n<h;n+=1)for(var t=0;t<k;t+=1)e=k*n+t,0===q[e]&&(n&&(r[e-k]=0),t&&(r[e-1]=0),r[e]=0,t<m&&(r[e+1]=0),n<f&&(r[e+k]=0));q=r}return new d(q,b.width,b.height)};a.Channel.dilate=function(a,b){for(var q=b.data,k=b.width,h=b.height,m=k-1,f=h-1,e=0;e<a;e+=1){for(var l=c(q.length),r=0;r<h;r+=1)for(var n=0;n<k;n+=
1){var t=k*r+n;0<q[t]&&(r&&(l[t-k]=255),n&&(l[t-1]=255),l[t]=255,n<m&&(l[t+1]=255),r<f&&(l[t+k]=255))}q=l}return new d(q,b.width,b.height)};a.Channel.and=function(a,b){for(var c=a.data,k=b.data,h=new d(a.width,a.height),m=h.data,f=0;f<c.length;f+=1)m[f]=c[f]&&k[f];return h};a.Channel.join=function(a,c,d,k,h){h=h||b(a.width,a.height);a=a.data;c=c.data;d=d.data;k=k.data;for(var m=h.data,f=0;f<a.length;f+=1){var e=4*f;m[e]=a[f];m[e+1]=c[f];m[e+2]=d[f];m[e+3]=k[f]}return h};a.Channel.set=function(a,b,
c){c=c.data;b=b.data;for(var d=0;d<b.length;d+=1)c[4*d+a]=b[d];return c};return a}();BONZ.MaskEditor=new function(){var a=this,c=null,b=null,d=null,g=[],p=null,q=null,k=null,h=null,m=null,f=null,e=null,l={},r=0,n=0,t=null,s=null,u;a.workingPane=null;a.resultPane=null;a.editMode="basic";a.maskId=null;a.eventContainer=null;a.currentTool=null;a.editable=!1;a.FILL_TYPES={erase:1,restore:2,userInput:3};a.FILL_STYLES={1:"#ff3333",2:"#33ff33"};a.cursor=null;a.deltas=[];a.activeDeltas=function(){return $.map(a.deltas,function(a){return a.undone?null:a})};a.lastDelta=function(){return a.deltas[a.deltas.length-
1]};a.lastActiveDelta=function(){var b=a.activeDeltas();return b[b.length-1]};a.image=null;a.blurRadius=2;a.isLittleEndian=!0;a.initialize=function(y,v,n){a.maskId=y;t=v;s=n;u=BONZ.BackgroundBurner.getDomain();c=$("#burn_pop_container");g=[];e={left:0,top:0};l={};r=0;a.deltas=[];$.ajax({url:u+"/background_burns/"+BONZ.BurnPop.getCurrentBurnId()+"/mask_edit_start",type:"GET"});c.addClass("editing");$("body").css({overflow:"hidden"});B();a.workingPane=new BONZ.MaskEditorCanvas.WorkingPane;g.push(a.workingPane);
a.workingPane.initialize();a.image=a.workingPane.image;a.resultPane=new BONZ.MaskEditorCanvas.ResultPane;g.push(a.resultPane);a.resultPane.initialize();l.greenRedBrush=new BONZ.MaskEditor.GreenRedBrush;l.brush=new BONZ.MaskEditor.Brush;l.polygon=new BONZ.MaskEditor.Polygon;BONZ.MaskEditorTools.initialize(d);$(window).on("resize",function(){BONZ.BackgroundBurner.smallScreen()&&A();$.each(g,function(){this.prepareMask({loadMask:!1})})});D();a.workingPane.imageContainer.scroll(function(){var b=a.workingPane.imageContainer.scrollLeft(),
c=a.workingPane.imageContainer.scrollTop();q.left-=p.left-b;q.top-=p.top-c;p={left:Math.floor(b),top:Math.floor(c)}});c.on("scroll",function(){var a=$(this),b=a.scrollLeft(),a=a.scrollTop();h.left-=k.left-b;h.top-=k.top-a;k={left:Math.floor(b),top:Math.floor(a)}});$("#editor_container .image_container").on("scroll.updateOther",x);"undefined"!==typeof Uint8ClampedArray&&(y=new ArrayBuffer(4),(new Uint32Array(y))[0]=168496141,a.isLittleEndian=!(10===y[0]&&11===y[1]&&12===y[2]&&13===y[3]));m=a.workingPane.imageContainer.find(".delta_container");
f=a.workingPane.imageContainer.find(".cursor_container");a.eventContainer=a.workingPane.imageContainer.find(".event_container");a.eventContainer.bind("selectstart dragstart",function(a){a.preventDefault();return!1});a.eventContainer.hover(a.handleEnterEditSpace,a.handleLeaveEditSpace);$(document).on("touchmove","#bmeditor",function(a){a.preventDefault()});$("#bmeditor").addClass("basic").attr("data-burn-mask-id",a.maskId);a.cursor=$("<div />").hide();f.append(a.cursor);a.executeTool("edit-erase-greenRedBrush-large");
BONZ.BackgroundBurner.smallScreen()&&a.executeTool("view-working");d.append($("<div />").addClass("work_status").append($("<span>").text("Working...")));$(b).height()+parseInt($(b).css("top"))>$(window).height()&&$(b).css({position:"absolute",top:$(window).scrollTop()});"undefined"!=typeof _gaq&&_gaq.push(["_trackPageview","background_burns/touch_up"])};a.close=function(){null!==c&&(c.removeClass("editing"),$("body").css({overflow:"auto"}));null!==b&&b.hide();BONZ.MaskEditorTools.hideToolTips()};
a.updatePanes=function(b){(!b||!b.original)&&BONZ.BurnSizzle&&BONZ.BurnSizzle.enableNavigationConfirmation("You have unsaved changed that will be lost, do you want to continue?");a.workingPane.reviseMask(b)};a.repositionContainers=function(b){m.css(b);b={height:b.height>a.workingPane.imageContainer.height()?b.height:a.workingPane.imageContainer.height(),width:b.width>a.workingPane.imageContainer.width()?b.width:a.workingPane.imageContainer.width()};f.css(b);e=f.offset();a.eventContainer.css(b);a.currentTool.updateCursor&&
a.currentTool.updateCursor()};a.afterLoadMask=function(){D();f.removeClass("loading");e=f.offset();a.editable=!0;BONZ.MaskEditorTools.activateToolset($(".toolsets li",d).first());a.cursor.css("left",-9999);a.handleEnterEditSpace();C()};a.undo=function(){var b=a.lastActiveDelta();0==a.deltas.length||("undefined"==typeof b||b.fillType==a.FILL_TYPES.userInput)||(b.canvas.addClass("undone").hide(),b.undone=!0,n=a.activeDeltas().length,$(".admin.toolset .total, .admin.toolset .current_index").text(n),
a.workingPane.undo())};a.hideDeltaContainer=function(){m.find("div").hide()};a.createDelta=function(b){b=b||{};var c=b.fillType||a.currentTool.fillType,d=b.filterClassName||(c==a.FILL_TYPES.erase?"erase":"restore");a.deltas.push({fillType:c,canvas:$("<canvas />").addClass("delta_canvas").addClass(d).attr("data-operation",c)});c=a.lastDelta();c.undone=!1;c.deltaContext=c.canvas.get(0).getContext("2d");m.append(c.canvas);c.canvas.css({width:a.workingPane.imageWidth(),height:a.workingPane.imageHeight()});
c.canvas.attr({height:b.height||a.workingPane.zoomBase.height,width:b.width||a.workingPane.zoomBase.width});n=a.activeDeltas().length;$(".admin.toolset .total, .admin.toolset .current_index").text(n);a.currentTool.prepareContext&&a.currentTool.prepareContext(c.deltaContext);return c};a.removeLastDelta=function(){var b=a.lastDelta();b&&(b.canvas.remove(),a.deltas.length--)};a.handleEnterEditSpace=function(){a.editable&&a.cursor.show();a.currentTool.updateCursor()};a.handleLeaveEditSpace=function(){a.cursor.hide();
a.editable&&a.currentTool.handleLeaveEditeSpace&&a.currentTool.handleLeaveEditeSpace()};a.handleMoveTool=function(b){b="touchmove"==b.type?b.originalEvent.touches[0]:b;a.cursor.css({left:b.pageX-e.left+q.left+h.left-1,top:b.pageY-e.top+q.top+h.top-1});a.editable&&a.cursor.show();a.currentTool.updateCursorBackground&&a.currentTool.updateCursorBackground({left:b.clientX,top:b.clientY})};a.getOffset=function(b){b="touchmove"==b.type?b.originalEvent.touches[0]:b;var c=a.workingPane.imageOffset();return!c?
{left:0,top:0}:{left:Math.round(b.pageX-c.left)/a.workingPane.currentZoomRatio,top:Math.round(b.pageY-c.top)/a.workingPane.currentZoomRatio}};a.updateWorkStatus=function(c){r+=c;a.isWorking()?b.find(".work_status").show():(b.find(".work_status").hide(),r=0)};a.isWorking=function(){return 0<r};a.completeZoom=function(){a.updateWorkStatus(-1);a.isWorking()||(a.editable=!0,q={left:0,top:0},h={left:0,top:0},C())};a.disableEditorSettings=function(){$("#editor_settings .tool").addClass("disabled")};a.enableEditorSettings=
function(){$("#editor_settings .tool").removeClass("disabled")};a.executeTool=function(b){if(!(/\bdisabled\b/.test(b)||/\bactive\b/.test(b)&&!/toggle/.test(b))){b=b.split(" ")[0];switch(b.split("-")[0]){case "edit":a.eventContainer.unbind("mousedown").unbind("mouseup").unbind("mousemove");a.eventContainer.off("touchstart").off("touchend").off("touchmove");a.eventContainer.mousemove(a.handleMoveTool);a.currentTool&&a.currentTool.unselect&&a.currentTool.unselect();z(b);b=b.split("-");a.currentTool=
l[b[2]].select(a.FILL_TYPES[b[1]]);"undefined"!==typeof b[3]&&a.currentTool.setSize(b[3]);a.currentTool.updateCursor&&a.currentTool.updateCursor();a.enableEditorSettings();break;case "zoom":if(a.isWorking())break;var c=b.split("-")[1];a.editable=!1;a.updateWorkStatus(1);$.each(g,function(){this.animateZoom(c)});break;case "undo":if(a.isWorking())break;a.undo();break;case "toggle":switch(b.split("-")[1]){case "edge":a.isWorking()||(z(b),a.updatePanes());break;case "mask":null!=a.resultPane&&(z(b),
a.resultPane.toggleMask())}break;case "view":switch(b.split("-")[1]){case "working":$(".image_container_wrapper").animate({marginLeft:0});break;case "result":$(".image_container_wrapper").animate({marginLeft:-0.6*$(window).width()})}z(b);break;case "mask":switch(b.split("-")[1]){case "previous":0<n&&(n-=1,a.updatePanes({upto:n}));break;case "next":n<a.activeDeltas().length&&(n+=1,a.updatePanes({upto:n}));break;case "last":0<a.activeDeltas().length&&(n=a.activeDeltas().length,a.updatePanes({upto:n}));
break;case "show":b=$("#composite_canvas").get(0).toDataURL(),window.open(b,"_blank")}$(".admin.toolset .current_index").text(n);break;case "debug":switch(b.split("-")[1]){case "refresh":a.workingPane.undo();break;case "show":var d=document.createElement("form");d.setAttribute("method","post");d.setAttribute("action","/background_masks/"+a.maskId+"/debug_image");var e="view"+Date.now();d.setAttribute("target",e);d.appendChild(v("uploadedImage",$("#composite_canvas").get(0).toDataURL()));d.appendChild(v("smooth",
$(".tool.toggle-edge").hasClass("active")?"false":"true"));"layers"==b.split("-")[2]&&d.appendChild(v("layers","1"));document.body.appendChild(d);window.open("",e);d.submit()}}a.currentTool.updateCursor()}};a.onImageLoad=function(a,b){$(a).each(function(){var a=$(this);"undefined"!=typeof a.get(0)&&(a.get(0).complete?b():a.load(function(){b()}))})};var w=function(){a.workingPane.saveMask({save:!0,callback:function(a){BONZ.BurnPop.selectMask(a,t)}})},v=function(a,b){var c=document.createElement("input");
c.setAttribute("type","hidden");c.setAttribute("name",a);c.setAttribute("value",b);return c},z=function(a){var b=/toggle/.test(a),c=a.split("-")[0];a=d.find(".tool_container .tool."+a);a.parents(".toolset").hasClass("utilities")||$("li.with_options.active",d).removeClass("active");b?a.toggleClass("active"):(d.find(".tool_container .tool").each(function(a,b){b=$(b);-1<b.attr("class").indexOf(" "+c+"-")&&b.removeClass("active")}),a.addClass("active"));b=a.parents("li.with_options");0<b.length&&b.addClass("active")},
B=function(){b=$("#bmeditor");0==b.length&&(b=$("<div id='bmeditor' />"),c.append(b));b.empty().show();b.append($("<div id='editor_container' />"));if(!BONZ.BackgroundBurner.smallScreen()){var a=$("<a href='javascript:void(0);' class='close_control' />");a.click(function(a){a.preventDefault();s(!1)});b.prepend(a)}var a=$("<div class='action_container' />"),e=$("<a href='http://www.bonanza.com/background_burns/faq#howtouchup' class='help' target='_blank' />"),f=$('<a href="#" class="button save"><i class="fa fa-check"></i>Finish</a>');
f.on("click",function(a){a.preventDefault();w()});var v=$('<a href="#" class="button cancel"><i class="fa fa-times"></i>Quit</a>');v.on("click",function(a){a.preventDefault();s(!0)});BONZ.BackgroundBurner.smallScreen()?a.append(v).append(e).append(f):a.append(e).append(v).append(f);b.append(a);b.disableSelection&&b.disableSelection();d=b.find("#editor_container");d.append($("<div class='image_container_wrapper' />"));BONZ.BackgroundBurner.smallScreen()&&A()},A=function(){var a=$(window).width();$(".image_container_wrapper",
d).css("width",2*(a-0.2*a))},x=function(){var a=$(this),b=a.siblings(".image_container");b.off("scroll.updateOther");b.scrollTop(a.scrollTop());b.scrollLeft(a.scrollLeft());b.on("scroll.updateOther",x)},C=function(){f.hide();a.eventContainer.hide();setTimeout(function(){f.show();a.eventContainer.show()},1)},D=function(){q={left:0,top:0};p={left:a.workingPane.imageContainer.scrollLeft(),top:a.workingPane.imageContainer.scrollTop()};h={left:0,top:0};k={left:c.scrollLeft(),top:c.scrollTop()}}};BONZ.MaskEditorTools=new function(){var a=this,c=null,b={basic:"Use the <strong>basic tools</strong> to quickly adjust the background and foreground. Dont worry about being too precise with the green and red markers. Just a few marks will tell the Background Burner what to do.",pixel:"Use the <strong>pixel tools</strong> for making precise edits.<br />The marquee and brush tools let you select exact areas, giving you more control over what to keep or remove."};a.initialize=function(b){c=BONZ.MaskEditor;
var e=!0===$("#burn_pop_container").data("admin")||"true"===$("#burn_pop_container").data("admin"),l=$('<div class="primary tool_container" />'),r=$('<div class="secondary tool_container" />'),n=$("<ul class='toolsets' />");n.append($("<li class='basic_toolset' data-toolset='basic'><a href='#'>Basic Tools</a></li>"));n.append($("<li class='pixel_toolset' data-toolset='pixel'><a href='#'>Pixel Tools</a></li>"));e&&n.append($("<li class='admin_toolset' data-toolset='admin'><a href='#'>Admin Tools</a></li>"));
l.append(n);$("a",n).click(function(b){b.preventDefault();a.activateToolset($(this).parent("li"))});var h=null,s=null;BONZ.BackgroundBurner.smallScreen()?(h=d("edit-erase-greenRedBrush-large","Mark Foreground (R)").addClass("eraser").data("function","eraser"),s=d("edit-restore-greenRedBrush-large","Mark Foreground (R)").addClass("restorer").data("function","restorer")):(h=d("bg-marker","Mark Background (E)").addClass("with_options eraser").data("function","eraser"),h.append($("<a href='#' class='options_toggle' />")),
n=$("<ul class='options' />"),n.append(d("edit-erase-greenRedBrush-large")),n.append(d("edit-erase-greenRedBrush-medium")),n.append(d("edit-erase-greenRedBrush-small")),h.append(n),s=d("fg-marker","Mark Foreground (R)").addClass("with_options restorer").data("function","restorer"),s.append($("<a href='#' class='options_toggle' />")),n=$("<ul class='options' />"),n.append(d("edit-restore-greenRedBrush-large")),n.append(d("edit-restore-greenRedBrush-medium")),n.append(d("edit-restore-greenRedBrush-small")),
s.append(n));n=$("<ul class='markers toolset' data-toolset='basic' />").hide();n.append(h).append(s);if(!BONZ.BackgroundBurner.smallScreen()){var u=d("edit-erase-polygon","Polygon Mask Eraser (C)").addClass("eraser").data("function","eraser"),h=d("edit-restore-polygon","Polygon Mask Restorer (V)").addClass("restorer").data("function","restorer"),w=$("<ul class='marquee toolset' data-toolset='pixel' />").hide();w.append(u).append(h);h=d("bg-brush","Erase Background (D)").addClass("with_options eraser").data("function",
"eraser");h.append($("<a href='#' class='options_toggle' />"));u=$("<ul class='options' />");u.append(d("edit-erase-brush-large"));u.append(d("edit-erase-brush-medium"));u.append(d("edit-erase-brush-small"));h.append(u);s=d("fg-brush","Restore Foreground (F)").addClass("with_options restorer").data("function","restorer");s.append($("<a href='#' class='options_toggle' />"));u=$("<ul class='options' />");u.append(d("edit-restore-brush-large"));u.append(d("edit-restore-brush-medium"));u.append(d("edit-restore-brush-small"));
s.append(u);u=$("<ul class='brushes toolset' data-toolset='pixel' />").hide();u.append(h).append(s)}h=d("undo","Undo (ctrl Z)");s=$("<ul class='primary utilities toolset' />");s.append(h);var v=d("zoom-out","Zoom Out (-)"),z=d("zoom-in","Zoom In (+)"),B=d("toggle-edge","Toggle Smooth Edges (S)"),A=d("toggle-mask","Toggle Checkerboard Background (T)"),h=$("<ul class='secondary utilities toolset' />");BONZ.BackgroundBurner.smallScreen()||(h.append(v),h.append(z));BONZ.BackgroundBurner.smallScreen()||
h.append(B);h.append(A);if(!BONZ.BackgroundBurner.smallScreen()&&e){var x=$("<div class='admin toolset' data-toolset='admin' />").hide();x.append('<div class="tool_context admin-mask"><label>Deltas:</label> [<span class="current_index">0</span>/<span class="total">0</span>]<span class="tool mask-previous"><a href="#">&laquo; Back</a></span><span class="tool mask-next"><a href="#">Forward &raquo;</a></span><span class="tool mask-last"><a href="#">Last &raquo;&raquo;</a></span><span class="tool mask-show"><a href="#">View composite</a></span></div>');
x.append('<div class="tool_context admin-mask"><span class="tool debug-refresh"><a href="#">Refresh</a></span> | <label>Debug image:</label><span class="tool debug-show"><a href="#">Open in new window</a></span> | <span class="tool debug-show-layers"><a href="#">Open layered in new window</a></span></div><br />')}v=$("<div class='wrapper' />");v.append(n);v.append(u);v.append(w);!BONZ.BackgroundBurner.smallScreen()&&e&&v.append(x);v.append(s);BONZ.BackgroundBurner.smallScreen()||v.append(h);l.append(v);
BONZ.BackgroundBurner.smallScreen()&&(w=d("view-working","View Working Pane"),x=d("view-result","View Result Pane"),e=$("<ul class='pane_switcher toolset' />"),e.append(w),e.append(x),w=$("<div class='wrapper' />"),w.append(h),w.append(e),r.append(w));g(l);q();k();e=l.add(r);$(".toolset .tool.with_options > a:first-child",e).mousedown(function(a){a.preventDefault();p($(".options").filter(":visible"));c.executeTool($(a.target).parent(".tool").find(".options .tool").first().attr("class").replace("tool ",
""))});$(".toolset .tool",e).not(".with_options").find("a").mousedown(function(a){a.preventDefault();p($(".options").filter(":visible"));c.executeTool($(a.target).parent(".tool").attr("class").replace("tool ",""))});$(".toolset .tool a",e).mousedown(function(){m()});e.find("a").click(function(a){a.preventDefault();return!1});b.prepend(l);BONZ.BackgroundBurner.smallScreen()&&b.append(r)};a.activateToolset=function(a){if(!a.hasClass("active")){var b=a.data("toolset"),d=$(".toolset .tool.active").first();
$(".tool.active",d);var d=d.data("function"),g=$(".toolset[data-toolset]").hide().filter("[data-toolset="+b+"]").css("display","inline-block");$(".options").filter(":visible").hide();a.addClass("active").siblings("li").removeClass("active");a=$(".tool",g).filter("."+d).find(".tool").first();0<a.length&&c.executeTool(a.attr("class").replace("tool ",""));$(".toolset.utilities").toggle("admin"!=b);a=$(".bbeditor_tip.bubbletip").filter(":visible");null==$.cookie("bb"+b)?0<a.length?m(function(){h(b)}):
h(b):0<a.length&&m()}};a.hideToolTips=function(){m()};var d=function(a,b){var c=$("<li class='tool' />").addClass(a);void 0!==typeof b&&c.attr("alt",b).data("title",b);return c.append($("<a href='#' />"))},g=function(a){$("li.with_options a.options_toggle",a).click(function(a){a.preventDefault();a=$(this).addClass("active").siblings(".options");if(0==a.filter(":visible").length){var b=$(".options").filter(":visible");0<b.length&&p(b);a.show().parents(".with_options").addClass("active")}else p(a)});
$(document).click(function(a){var b=$(".options").filter(":visible");0<b.length&&(a.preventDefault(),p(b))})},p=function(a){var b=a.parents(".with_options");a.hide();$(".options_toggle",b).removeClass("active");0==$(".active",a).length&&b.removeClass("active")},q=function(){BONZ.BackgroundBurner.smallScreen()||($(document).on("mouseover",".toolset .tool",function(){BONZ.BackgroundBurner.createFakeTitleTip($(this))}),$(document).on("mouseout",".toolset .tool",function(){$("body .fake_title").remove()}))},
k=function(){$(document).off("keydown.tools");$(document).on("keydown.tools",function(a){if(0<$("#bmeditor:visible").length){var b=a.ctrlKey||17==a.which||a.metaKey||91==a.which;switch(a.which){case 9:a=$(".toolsets .active").next();0==a.length&&(a=$(".toolsets li").first());BONZ.MaskEditorTools.activateToolset(a);break;case 27:a=$(".options").filter(":visible");0<a.length?a.hide():$("#bmeditor .action_container .cancel").click();break;case 67:a=$("#bmeditor .tool.edit-erase-polygon");c.executeTool(a.attr("class").replace("tool ",
""));break;case 68:a=$("#bmeditor .bg-brush .active").next();0==a.length&&(a=$(".bg-brush .tool").first());c.executeTool(a.attr("class").replace("tool ",""));break;case 69:a=$("#bmeditor .bg-marker .active").next();0==a.length&&(a=$(".bg-marker .tool").first());c.executeTool(a.attr("class").replace("tool ",""));break;case 70:a=$("#bmeditor .fg-brush .active").next();0==a.length&&(a=$(".fg-brush .tool").first());c.executeTool(a.attr("class").replace("tool ",""));break;case 82:a=$("#bmeditor .fg-marker .active").next();
0==a.length&&(a=$(".fg-marker .tool").first());c.executeTool(a.attr("class").replace("tool ",""));break;case 83:$(".tool.toggle-edge").hasClass("disabled")||c.executeTool("toggle-edge");break;case 84:$(".tool.toggle-mask").hasClass("disabled")||c.executeTool("toggle-mask");break;case 86:a=$(".tool.edit-restore-polygon");c.executeTool(a.attr("class").replace("tool ",""));break;case 90:b&&!$(".tool.undo").hasClass("disabled")&&c.executeTool("undo");break;case 61:case 187:$(".tool.zoom-in").hasClass("disabled")||
c.executeTool("zoom-in");break;case 173:case 189:$(".tool.zoom-out").hasClass("disabled")||c.executeTool("zoom-out")}}})},h=function(a){var c=b[a];if(null!=c){var d=$("<div />").addClass("bbeditor_tip bubbletip").addClass(a),g=$("<a />").attr("href","#").addClass("close_control").append($("<i class='fa fa-times' />"));d.append($("<div />").attr("id","bubbletip").addClass("bubbletip_arrow bubbletip_arrow_up"));d.append($("<div />").addClass("bubbletip_inner").html(c).append(g));d.appendTo($("body")).hide().fadeIn("fast");
g.click(function(b){b.preventDefault();$.cookie("bb"+a,!0,{path:"/",domain:BONZ.cookie_domain||BONZ.api_domain,expires:7300});m()})}},m=function(a){$(".bbeditor_tip.bubbletip").fadeOut("fast",function(){$(this).remove();void 0!==a&&a()})}};BONZ.MaskEditorCanvas=function(){var a=this,c;a.currentZoomRatio;a.image;a.imageContainer;a.manager;a.mask;a.name;a.zoomBase={};a.initialize=function(){a.manager=BONZ.MaskEditor;a.imageContainer=$("<div />").addClass("image_container loading").addClass(a.name);a.image=$("<img />").attr("id",a.name+"_image").addClass("edited_image");a.imageContainer.append(a.image);a.mask=$("<canvas />").addClass("mask").addClass(a.name);a.imageContainer.append(a.mask);$("#bmeditor #editor_container .image_container_wrapper").append(a.imageContainer)};
a.animateZoom=function(b,d,g){var p,q,k,h,m;b="fit"==b?c:a.currentZoomRatio+0.25*("in"==b?1:-1);var f,e;0<b&&2>b?a.currentZoomRatio=b:a.manager.completeZoom();b=a.imageHeight();m=a.imageWidth();f={height:a.zoomBase.height*a.currentZoomRatio,width:a.zoomBase.width*a.currentZoomRatio};k=a.imageContainer.scrollTop();h=a.imageContainer.scrollLeft();p=a.imageContainer.scrollTop()+(f.height-b)/2;q=a.imageContainer.scrollLeft()+(f.width-m)/2;e=f.width-m;a.imageContainer.find("img, .mask").animate(f,{duration:$.browser.msie?
0:200,complete:function(a,b){$(this).hasClass("mask")&&g&&g()},step:function(b,c){if("width"==c.prop||$(c.elem).hasClass("mask")){var f=c.end-c.now;a.imageContainer.scrollTop(-1*(f*(p-k)/e-p));a.imageContainer.scrollLeft(-1*(f*(q-h)/e-q));d&&d()}}})};a.clearContext=function(b){b.clearRect(0,0,a.zoomBase.width,a.zoomBase.height)};a.createControlContainer=function(b){b=$("<div />").addClass(b+"_container");a.imageContainer.append(b);return b};a.imageCSS=function(){return{width:a.image.width(),height:a.image.height(),
"margin-left":a.image.css("margin-left"),"margin-top":a.image.css("margin-top")}};a.imageHeight=function(){return a.image.height()};a.imageWidth=function(){return a.image.width()};a.imageOffset=function(){return a.image.offset()};a.imagePositionCSS=function(){var b=a.imageHeight(),c=a.imageWidth(),g=Math.round((a.imageContainer.height()-b)/2),p=Math.round((a.imageContainer.width()-c)/2);return{height:b,width:c,"margin-top":Math.max.apply(null,[0,g]),"margin-left":Math.max.apply(null,[0,p])}};a.prepareMask=
function(){a.image.css({height:"",width:"","max-height":a.imageContainer.height(),"max-width":a.imageContainer.width()});var b=a.imageHeight(),d=a.imageWidth();a.image.css({"max-height":"none","max-width":"none"});a.currentZoomRatio=0.95*(d/a.image.naturalWidth());c=a.currentZoomRatio;a.zoomBase.height=a.image.naturalHeight();a.zoomBase.width=a.image.naturalWidth();a.image.css({height:0.95*b,width:0.95*d});a.imageContainer.removeClass("loading");a.image.css(a.imagePositionCSS())};a.updateCanvasPattern=
function(b,c){var g=b.get(0).getContext("2d"),p=$(c).naturalWidth(),q=$(c).naturalHeight();a.clearContext(g);b.attr("height",q).attr("width",p);g.rect(0,0,p,q);g.fillStyle=g.createPattern(c,"no-repeat");g.fill()}};BONZ.MaskEditorCanvas.ResultPane=function(a){var c=this,b=BONZ.MaskEditorCanvas.ResultPane.prototype;c.activeMask="opaque";c.checkerboardMaskImage=null;c.opaqueMaskImage=null;c.initialize=function(){b.name="result";b.initialize.call()};c.animateZoom=function(a){b.animateZoom(a,c.repositionContainers)};c.prepareMask=function(){b.prepareMask();b.mask.css(b.imageCSS());c.repositionContainers()};c.toggle=function(){b.toggle(c)};c.toggleMask=function(){"checkerboard"==c.activeMask?(c.activeMask="opaque",
b.updateCanvasPattern(b.mask,c.opaqueMaskImage)):(c.activeMask="checkerboard",b.updateCanvasPattern(b.mask,c.checkerboardMaskImage))};c.repositionContainers=function(){var a=b.imagePositionCSS();0==a.height||0==a.width||(b.image.css(a),null!=b.mask&&b.mask.css(a))}};BONZ.MaskEditorCanvas.ResultPane.prototype=new BONZ.MaskEditorCanvas;BONZ.MaskEditorCanvas.WorkingPane=function(a){var c=this,b=BONZ.MaskEditorCanvas.WorkingPane.prototype,d=null,g=null,p=null,q=null,k=!1,h=null,m=null,f=document.createElement("canvas"),e=f.getContext("2d");c.outline=null;c.initialize=function(){b.name="working";b.initialize.call();p=$('<canvas id="original_canvas"></canvas>');p.get(0).getContext("2d");b.createControlContainer("cursor").css({zIndex:10});b.createControlContainer("event").css({zIndex:20});var a=$("#burn_pop_container .last_delta");a.get(0)?
(b.imageContainer.append(a),a.removeClass("last_delta"),d=a.find("#composite_canvas"),g=d.get(0).getContext("2d"),$.each(a.find("canvas.delta_canvas"),function(){b.manager.deltas.push({fillType:parseInt($(this).attr("data-operation")),deltaContext:this.getContext("2d"),canvas:$(this)})})):(b.createControlContainer("delta").css({zIndex:2}),d=$('<canvas id="composite_canvas"></canvas>'),g=d.get(0).getContext("2d"),$(".delta_container").append(d));d.hide();$("#burn_pop_container").remove(".last_delta");
c.outline=$("<canvas />").attr("id","outline_image").removeClass("edited_image").addClass("zoomable").data("loaded",!1);b.imageContainer.append(c.outline);$.ajax({url:BONZ.BackgroundBurner.getDomain()+"/png_proxy/background_masks/"+b.manager.maskId+"/show_display_image",dataType:"json",cache:!1,success:function(a){c.image.attr("src",a.encoded);null!=b.manager.resultPane&&b.manager.resultPane.image.attr("src",a.encoded);BONZ.MaskEditor.onImageLoad(c.image,function(){c.prepareMask();null!=b.manager.resultPane&&
b.manager.resultPane.prepareMask()})}})};c.animateZoom=function(a){b.animateZoom(a,c.repositionContainers,function(){c.repositionContainers();setTimeout(function(){b.manager.completeZoom()},10)});b.manager.hideDeltaContainer()};c.injectOutlineClarity=function(a,d){var e=c.outline;if(e.data("loaded")){var f=e.get(0),g=f.getBoundingClientRect(),l=f.getContext("2d"),h=Math.round((a.left-g.left)/(g.right-g.left)*f.width),g=Math.round((a.top-g.top)/(g.bottom-g.top)*f.height);b.clearContext(l);l.beginPath();
l.arc(h,g,Math.round(d*f.width/e.width()),0,2*Math.PI);l.rect(f.width,0,-1*f.width,f.height);l.fill()}};c.prepareMask=function(a){a=$.extend({loadMask:!0},a);b.prepareMask();b.mask.css({"max-height":"none","max-width":"none"}).hide();c.outline.css({"max-height":"none","max-width":"none"});d.attr({height:2*b.zoomBase.height,width:b.zoomBase.width});a.loadMask&&(b.manager.updatePanes({original:!0}),b.mask.toggle(0==$(".toolsets .basic_toolset.active").length));c.repositionContainers();b.manager.afterLoadMask()};
c.redrawComposite=function(a){"undefined"==typeof a&&(a={});g.clearRect(0,0,b.zoomBase.width,2*b.zoomBase.height);var c=t("basic_canvas"),d=c.get(0).getContext("2d"),e=t("advanced_canvas"),f=e.get(0).getContext("2d"),l=t(null).addClass("temp_canvas"),h=l.get(0).getContext("2d"),k,n,m;$.each(b.manager.activeDeltas(),function(c,e){if(!e.undone&&!e.canvas.hasClass("painting")&&!(void 0!==a.upto&&c>a.upto-1)){e.canvas.is(":visible")&&e.canvas.addClass("processing");b.clearContext(h);h.globalCompositeOperation=
"source-over";h.drawImage(e.canvas.get(0),0,0,b.zoomBase.width,b.zoomBase.height);if(e.fillType!=b.manager.FILL_TYPES.userInput){switch(e.canvas.data("data-type")){case "marker":k=e.fillType==b.manager.FILL_TYPES.erase?"#400000":"#C00000";break;case "pixel":k=e.fillType==b.manager.FILL_TYPES.erase?"#0000FF":"#00FF00"}n=l.clone();m=n.get(0).getContext("2d");b.clearContext(m);m.beginPath();m.rect(0,0,b.zoomBase.width,b.zoomBase.height);m.fillStyle=k;m.fill();h.globalCompositeOperation="source-in";h.drawImage(n.get(0),
0,0)}"marker"==e.canvas.data("data-type")?(d.mozImageSmoothingEnabled=!1,d.webkitImageSmoothingEnabled=!1,d.msImageSmoothingEnabled=!1,d.imageSmoothingEnabled=!1,d.drawImage(l.get(0),0,0)):f.drawImage(l.get(0),0,0);$("#composite_canvas").hasClass("view-original")&&e.canvas.hide()}});g.drawImage(c.get(0),0,0);g.drawImage(e.get(0),0,b.zoomBase.height)};c.toggleCutoutMask=function(a){var c=a==b.manager.FILL_TYPES.restore?h:m;b.manager.onImageLoad(c,function(){b.updateCanvasPattern(b.mask,c)})};c.reviseMask=
function(a){"undefined"==typeof a&&(a={});if(k)q=a;else{var d=+new Date;c.redrawComposite(a);b.manager.updateWorkStatus(1);k=!0;a.includeContainerDimensions=!0;$.ajax($.extend(n(a),{url:BONZ.BackgroundBurner.getDomain()+"/background_masks/"+b.manager.maskId+"/revise?"+d,success:function(d){var e,f=new Image,g=new Image,l=new Image;d=$.parseJSON(d);g.src="data:image/png;base64,"+d.mask;null!=b.manager.resultPane&&(b.manager.resultPane.opaqueMaskImage=g);b.manager.onImageLoad(g,function(){h=s(g,b.manager.FILL_STYLES[b.manager.FILL_TYPES.restore],
"destination-out");m=s(g,b.manager.FILL_STYLES[b.manager.FILL_TYPES.erase],"destination-atop");c.toggleCutoutMask(b.manager.currentTool.fillType);null!=b.manager.resultPane&&"opaque"==b.manager.resultPane.activeMask&&b.updateCanvasPattern(b.manager.resultPane.mask,g);if(b.manager.resultPane&&!b.manager.resultPane.checkerboardMaskImage&&(l=u(g),null!=b.manager.resultPane&&(b.manager.resultPane.checkerboardMaskImage=l),null!=b.manager.resultPane&&"checkerboard"==b.manager.resultPane.activeMask))b.manager.onImageLoad(l,
function(){b.updateCanvasPattern(b.manager.resultPane.mask,l)});e="basic"==b.manager.currentTool.toolset;b.imageContainer.width()&&b.imageContainer.height()&&(f=w(g,b.imageContainer.width(),b.imageContainer.height()),b.manager.onImageLoad(f,function(){b.updateCanvasPattern(c.outline,f);c.outline.css(b.imageCSS()).data("loaded",!0).toggle(e)}))});d.user_input_markers&&r(d.user_input_markers,"marker");d.user_input_pixels&&r(d.user_input_pixels,"pixel");$(".delta_container canvas.processing").fadeOut("fast").removeClass("processing");
b.manager.updateWorkStatus(-1);k=!1;null!=q&&(a=q,q=null,c.reviseMask(a))}}))}};c.saveMask=function(a){var d=+new Date;0<(popup_container=$("#burn_pop_container")).length&&popup_container.hasClass("burn_ward")&&$.extend(a,{not_final_mask:!0});b.manager.updateWorkStatus(1);$.ajax($.extend(n(a),{url:BONZ.BackgroundBurner.getDomain()+"/background_masks/"+b.manager.maskId+"?"+d,success:function(d,e,f){if(a.callback){if(d=f.getResponseHeader("X-BackgroundMaskId"))b.manager.maskId=d;a.callback(d)}d=c.imageContainer.find(".delta_container");
e=$(d).closest(".popup_container");e.remove(".last_delta");d.attr("data-mask-id",b.manager.maskId).addClass("last_delta");e.append(d)}}))};c.undo=function(){b.manager.updatePanes()};c.repositionContainers=function(){var a=b.imagePositionCSS(),e={height:a.height,width:a.width};0==a.height||0==a.width||($(".delta_canvas").css(e),d.css({height:2*a.height,width:a.width}),c.outline.css(a),b.manager.repositionContainers(a),c.image.css(a),null!=b.mask&&b.mask.css(a))};var l=function(a,b,c){"function"==$.type(a.append)?
a.append(b,c):a[b]=c},r=function(a,c){var d,e;d=b.manager.createDelta({fillType:b.manager.FILL_TYPES.userInput,filterClassName:"user_input_"+c,height:b.zoomBase.height,width:b.zoomBase.width});d.canvas.data("data-type",c);d.canvas.hide();e=new Image;e.src="data:image/png;base64,"+a;$(e).on("load",function(){d.deltaContext.drawImage(e,0,0);d.canvas.css({height:b.manager.workingPane.imageHeight(),width:b.manager.workingPane.imageWidth()})})},n=function(a){"undefined"==typeof a&&(a={});var c=new FormData,
d=!$(".tool.toggle-edge").hasClass("active")||BONZ.BackgroundBurner.smallScreen();l(c,"submit",!0);l(c,"smooth",d);a.save&&l(c,"save",1);a.includeContainerDimensions&&(l(c,"container[height]",b.imageContainer.height()),l(c,"container[width]",b.imageContainer.width()));a.not_final_mask&&l(c,"not_final_mask",a.not_final_mask);a.original||(a=$("#composite_canvas").get(0).toDataURL("image/png"),"undefined"!=typeof window.MozBlobBuilder||"undefined"!=typeof window.WebKitBlobBuilder?(d=new (window.MozBlobBuilder||
window.WebKitBlobBuilder),d.append(a),a=d.getBlob("image/png")):a="undefined"!=typeof window.Blob?new Blob([a],{type:"image/png"}):void 0,l(c,"uploadedImage",a));l(c,"userInputVersion","1");c={data:c,dataType:"HTML",type:"POST"};$.extend(c,{processData:!1,contentType:!1});return c},t=function(a){return d.clone().attr({id:a,height:b.zoomBase.height}).css({height:b.zoomBase.height})},s=function(a,b,c){var d=$(a).naturalWidth(),g=$(a).naturalHeight();f.width=d;f.height=g;e.rect(0,0,d,g);e.fillStyle=
b;e.fill();e.globalCompositeOperation=c;e.drawImage(a,0,0);a=new Image;a.src=f.toDataURL();return a},u=function(a){var b=$(a).naturalWidth(),c=$(a).naturalHeight();f.width=b;f.height=c;e.drawImage(a,0,0);e.lineWidth=15;e.strokeStyle="#999";e.fillStyle="#666";e.globalCompositeOperation="source-atop";ImageTools.Context.fillCheck(e,0,0,b,c);a=new Image;a.src=f.toDataURL();return a},w=function(a,b,c){var d=$(a).naturalWidth(),g=$(a).naturalHeight();b=d/b;c=g/c;b=b>c?b:c;c=[Math.round(d/b),Math.round(g/
b)];b=c[0];c=c[1];f.width=b;f.height=c;e.drawImage(a,0,0,d,g,0,0,b,c);a=e.getImageData(0,0,b,c);g=ImageTools.Channel.extract(3,a);g=ImageTools.Channel.threshold(255,g);d=ImageTools.Channel.dilate(1,g);g=ImageTools.Channel.erode(1,g);d=ImageTools.Channel.and(d,ImageTools.Channel.invert(g));b=new ImageTools.ChannelData(b,c);c=ImageTools.Channel.dilate(2,d);ImageTools.Channel.join(d,d,b,c,a);e.putImageData(a,0,0);b=new Image;b.src=f.toDataURL();return b}};
BONZ.MaskEditorCanvas.WorkingPane.prototype=new BONZ.MaskEditorCanvas;BONZ.MaskEditor.Brush=function(){var a=this;a.editor=BONZ.MaskEditor;a.painting=!1;a.lastBrushOffset=null;a.radius=0;a.BRUSH_SIZES={small:5,medium:10,large:19};a.brushSize=a.BRUSH_SIZES.large;a.name="brush";a.fillType=null;a.toolset="pixel";a.select=function(c){a.fillType=c;a.editor.eventContainer.bind("mousedown.BONZ.MaskEditor.Brush",a.startPainting);a.editor.eventContainer.bind("mouseup.BONZ.MaskEditor.Brush",a.stopPainting);a.editor.eventContainer.bind("mousemove.BONZ.MaskEditor.Brush",a.paint);
$(window).bind("mouseup.BONZ.MaskEditor.Brush",function(){a.painting&&a.stopPainting()});a.editor.workingPane.toggleCutoutMask(c);a.editor.workingPane.mask.show();a.editor.workingPane.outline.hide();BONZ.MaskEditorTools.activateToolset($(".toolsets .pixel_toolset"));return a};a.setSize=function(c){a.brushSize=a.BRUSH_SIZES[c];a.radius=Math.floor(a.brushSize/2)};a.prepareContext=function(c){c.beginPath();c.strokeStyle=a.editor.FILL_STYLES[a.fillType];c.lineWidth=a.brushSize/a.editor.workingPane.currentZoomRatio;
c.lineCap="round";c.lineJoin="round"};a.handleLeaveEditeSpace=function(){a.lastBrushOffset=null};a.updateCursor=function(){a.editor.cursor.html("");a.editor.cursor.css({position:"absolute",background:a.editor.FILL_STYLES[a.fillType],height:2*a.radius,width:2*a.radius,"margin-top":-1*a.radius,"margin-left":-1*a.radius,"-moz-border-radius":a.radius,"border-radius":a.radius,border:"1px solid "+a.editor.FILL_STYLES[a.fillType],"z-index":20})};a.startPainting=function(c){a.editor.editable&&!a.painting&&
(a.painting=!0,c=a.editor.getOffset(c),a.lastBrushOffset=c,a.editor.createDelta().canvas.addClass("painting"),a.updateCursor())};a.stopPainting=function(){a.painting&&(a.painting=!1,a.updateCursor(),a.editor.lastDelta().canvas.data("data-type","pixel").removeClass("painting"),a.editor.updatePanes())};a.paint=function(c){if(a.painting){c=a.editor.getOffset(c);var b=a.editor.lastDelta().deltaContext;a.lastBrushOffset||(a.lastBrushOffset=c);b.moveTo(a.lastBrushOffset.left,a.lastBrushOffset.top);b.lineTo(c.left,
c.top);b.stroke();a.lastBrushOffset=c}}};BONZ.MaskEditor.GreenRedBrush=function(){var a=this;a.clarityRadius=38;a.toolset="basic";a.select=function(c){a.fillType=c;a.editor.eventContainer.bind("mousedown.BONZ.MaskEditor.GreenRedBrush",a.startPainting);a.editor.eventContainer.bind("mouseup.BONZ.MaskEditor.GreenRedBrush",a.stopPainting);a.editor.eventContainer.bind("mousemove.BONZ.MaskEditor.GreenRedBrush",a.paint);$(window).bind("mouseup.BONZ.MaskEditor.GreenRedBrush",function(b){a.painting&&a.stopPainting(b)});a.editor.eventContainer.on("touchstart.BONZ.MaskEditor.GreenRedBrush",
a.startPainting);a.editor.eventContainer.on("touchend.BONZ.MaskEditor.GreenRedBrush",a.stopPainting);a.editor.eventContainer.on("touchmove.BONZ.MaskEditor.GreenRedBrush",a.paint);a.editor.workingPane.mask.hide();a.editor.workingPane.outline.show();BONZ.MaskEditorTools.activateToolset($(".toolsets .basic_toolset"));return a};a.prepareContext=function(c){c.beginPath();c.strokeStyle=a.editor.FILL_STYLES[a.fillType];c.lineWidth=a.brushSize/a.editor.workingPane.currentZoomRatio;c.lineCap="round";c.lineJoin=
"round"};a.updateCursor=function(){a.editor.cursor.html("");a.editor.cursor.css({position:"absolute",background:a.editor.FILL_STYLES[a.fillType],height:2*a.radius,width:2*a.radius,"margin-top":-1*a.radius,"margin-left":-1*a.radius,"-moz-border-radius":a.radius,"border-radius":a.radius,border:"1px solid "+a.editor.FILL_STYLES[a.fillType],"z-index":20})};a.updateCursorBackground=function(c){a.editor.workingPane.injectOutlineClarity(c,a.clarityRadius)};a.startPainting=function(c){if(a.editor.editable&&
!(a.painting||void 0!==c.originalEvent.touches&&1<c.originalEvent.touches.length))a.painting=!0,c=a.editor.getOffset(c),a.lastBrushOffset=c,a.editor.createDelta().canvas.addClass("painting"),a.updateCursor(),a.updateCursorBackground(c)};a.stopPainting=function(c){a.painting&&(a.painting=!1,a.updateCursor(),a.updateCursorBackground(a.editor.getOffset(c)),a.editor.lastDelta().canvas.data("data-type","marker").removeClass("painting"),a.editor.updatePanes())};a.paint=function(c){if(a.painting){c=a.editor.getOffset(c);
var b=a.editor.lastDelta().deltaContext;a.lastBrushOffset||(a.lastBrushOffset=c);b.moveTo(a.lastBrushOffset.left,a.lastBrushOffset.top);b.lineTo(c.left,c.top);b.stroke();a.lastBrushOffset=c}}};BONZ.MaskEditor.GreenRedBrush.prototype=new BONZ.MaskEditor.Brush;BONZ.MaskEditor.Polygon=function(){var a=this,c=BONZ.MaskEditor,b=[],d=null,g=null;a.brushSize=4;a.name="wand";a.fillType=null;a.toolset="pixel";a.select=function(b){a.fillType=b;c.eventContainer.mouseup(p);c.eventContainer.mousemove(q);var d=$('<canvas class="delta_canvas" height=2 width=2></canvas>'),f=d.get(0).getContext("2d");f.fillStyle=a.fillType==c.FILL_TYPES.erase?"#711717":"#177117";f.fillRect(0,0,1,1);f.fillStyle=a.fillType==c.FILL_TYPES.erase?"#f00":"#0f0";f.fillRect(0,0,0,0);f.fillRect(1,
1,1,1);g=f.createPattern(d.get(0),"repeat");c.workingPane.toggleCutoutMask(b);c.workingPane.mask.show();c.workingPane.outline.hide();BONZ.MaskEditorTools.activateToolset($(".toolsets .pixel_toolset"));return a};a.unselect=function(){d&&(d=null,b=[],c.removeLastDelta())};a.updateCursor=function(){c.cursor.html("");c.cursor.css({position:"absolute",background:"none",height:"17px",width:"17px","margin-top":"-8px","margin-left":"-8px",border:"none"}).addClass("polygon");c.cursor.append($('<div class="polygon_pointer"></div>'))};
var p=function(a){c.editable&&(d||(d=c.createDelta().deltaContext),a=c.getOffset(a),b.push(a),h(a)?(f(a),c.enableEditorSettings()):c.disableEditorSettings())},q=function(a){d&&(a=c.getOffset(a),k(a),m(a))},k=function(a){var f=d;c.workingPane.clearContext(f);f.beginPath();f.strokeStyle=g;f.lineWidth=1/c.workingPane.currentZoomRatio;f.lineCap="round";f.lineJoin="round";var h=b[0];b.push(a);$.each(b,function(a,b){0!=a&&(f.moveTo(h.left,h.top),f.lineTo(b.left,b.top),f.stroke(),h=b)});b.pop()},h=function(a){if("undefined"!=
typeof a&&2<b.length){var c=a.left-b[0].left;a=a.top-b[0].top;return 5>c&&-5<c&&5>a&&-5<a}return!1},m=function(a){$(".polygon_pointer",c.cursor).toggleClass("closeable",h(a))},f=function(){var e,f,g;g=b[0];b.length--;c.removeLastDelta();e=c.createDelta();e.canvas.data("data-type","pixel");f=e.deltaContext;f.beginPath();f.lineWidth=1/c.workingPane.currentZoomRatio;f.strokeStyle=c.FILL_STYLES[a.fillType];f.fillStyle=c.FILL_STYLES[a.fillType];f.moveTo(g.left,g.top);$.each(b,function(a,b){0!=a&&(f.lineTo(b.left,
b.top),g=b)});f.closePath();f.fill();f.stroke();c.updatePanes();b=[];d=null;m()}};


if (typeof(BONZ) !== 'undefined' && BONZ.packageLoaded) BONZ.packageLoaded('burn_bundle');
//# sourceMappingURL=burn_bundle.js.map
